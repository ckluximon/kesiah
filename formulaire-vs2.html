<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulaire Réunion Équipe VS2 - Solerys</title>
    <meta name="description" content="Formulaire pour organiser les réunions d'équipe VS2 et générer automatiquement les comptes-rendus">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background-image: url('https://via.placeholder.com/1200x120/8bc34a/ffffff?text=REMPLACER+PAR+VOTRE+BANDEAU+SOLERYS');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: white;
            padding: 20px 0;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 120px;
            display: flex;
            align-items: center;
        }

        .header-content {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            position: relative;
            z-index: 2;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-right {
            text-align: right;
        }

        .meeting-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .meeting-subtitle {
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            .header-right {
                text-align: center;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #ecf0f1;
            border-radius: 3px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8bc34a, #9ccc65);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e8ecef;
            border-radius: 10px;
            background: #fafbfc;
        }

        .section h3 {
            color: #8bc34a;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #8bc34a;
            padding-bottom: 5px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #8bc34a;
            box-shadow: 0 0 0 3px rgba(139, 195, 74, 0.1);
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            border: 1px solid #e8ecef;
            transition: background-color 0.2s;
        }

        .checkbox-item:hover {
            background: #f8f9fa;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #8bc34a, #9ccc65);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #3498db, #5dade2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #e67e22, #f39c12);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .ordre-jour-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: move;
            transition: all 0.2s;
        }

        .ordre-jour-item input[type="text"] {
            font-size: 16px;
            padding: 12px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .ordre-jour-item textarea {
            font-size: 14px;
            padding: 12px;
            min-height: 80px;
            resize: vertical;
        }

        .ordre-jour-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .ordre-jour-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .delete-item {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            float: right;
            font-size: 12px;
        }

        .char-counter {
            font-size: 12px;
            color: #7f8c8d;
            text-align: right;
            margin-top: 5px;
        }

        .char-counter.warning {
            color: #e67e22;
        }

        .char-counter.danger {
            color: #e74c3c;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #8bc34a;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .save-status.show {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .form-container {
                padding: 20px;
            }
            .form-row {
                grid-template-columns: 1fr;
            }
            .btn-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="header-right">
                <div class="meeting-title">Réunion d'équipe VS2</div>
                <div class="meeting-subtitle">Partages des Pratiques Professionnelles</div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="form-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <form id="reunionForm">
                <!-- Informations générales -->
                <div class="section">
                    <h3>📋 Informations générales</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reference">Référence :</label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <input type="text" id="reference" name="reference" value="16166/VS25/" placeholder="Ex: 16166/VS25/0612" style="flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="ajouterDateReference()" style="padding: 8px 12px; font-size: 12px;">📅 + Date</button>
                            </div>
                            <div style="font-size: 11px; color: #666; margin-top: 3px;">Format suggéré: XXXXX/VS25/JJMM (cliquez "📅 + Date" pour ajouter la date automatiquement)</div>
                        </div>
                        <div class="form-group">
                            <label for="date">Date :</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Horaires :</label>
                            <div style="display: grid; grid-template-columns: 1fr auto 1fr auto; gap: 10px; align-items: center;">
                                <div>
                                    <label for="heureDebut" style="font-size: 12px; margin-bottom: 3px;">Début :</label>
                                    <input type="time" id="heureDebut" name="heureDebut" value="14:00" required onchange="updateHoraires()">
                                </div>
                                <span style="margin-top: 20px;">à</span>
                                <div>
                                    <label for="heureFin" style="font-size: 12px; margin-bottom: 3px;">Fin :</label>
                                    <input type="time" id="heureFin" name="heureFin" value="16:00" required onchange="updateHoraires()">
                                </div>
                                <div style="margin-top: 20px; font-size: 12px; color: #666;" id="dureeAffichage">(2h)</div>
                            </div>
                            <input type="hidden" id="horaires" name="horaires" value="14h00 à 16h00">
                        </div>
                        <div class="form-group">
                            <label for="animateur">Animateur :</label>
                            <input type="text" id="animateur" name="animateur" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="modalite">Modalité :</label>
                            <select id="modalite" name="modalite" required>
                                <option value="">Choisir la modalité</option>
                                <option value="Présentiel">Présentiel</option>
                                <option value="Distanciel">Distanciel</option>
                                <option value="Hybride">Hybride</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sites concernés -->
                <div class="section">
                    <h3>🏢 Sites concernés</h3>
                    <div class="checkbox-grid">
                        <div class="checkbox-item">
                            <input type="checkbox" id="site1" name="sites" value="Strasbourg">
                            <label for="site1">Strasbourg</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="site2" name="sites" value="Haguenau">
                            <label for="site2">Haguenau</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="site3" name="sites" value="Molsheim">
                            <label for="site3">Molsheim</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="site4" name="sites" value="Saverne">
                            <label for="site4">Saverne</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="site5" name="sites" value="Sélestat">
                            <label for="site5">Sélestat</label>
                        </div>
                    </div>
                </div>

                <!-- Participants -->
                <div class="section">
                    <h3>👥 Participants</h3>
                    
                    <h4 style="color: #8bc34a; margin-bottom: 10px;">Consultants présents :</h4>
                    <div class="checkbox-grid" id="consultantsPresents">
                        <div class="checkbox-item">
                            <input type="checkbox" id="cons1" name="consultants" value="Alicia DOUAIR" onchange="updateAbsents()">
                            <label for="cons1">Alicia DOUAIR</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cons2" name="consultants" value="Nathalie TRILLO" onchange="updateAbsents()">
                            <label for="cons2">Nathalie TRILLO</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cons3" name="consultants" value="Elodie ANTOINE" onchange="updateAbsents()">
                            <label for="cons3">Elodie ANTOINE</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cons4" name="consultants" value="Caroline BRACONNIER" onchange="updateAbsents()">
                            <label for="cons4">Caroline BRACONNIER</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cons5" name="consultants" value="Farida BENZIADA" onchange="updateAbsents()">
                            <label for="cons5">Farida BENZIADA</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cons6" name="consultants" value="Michele BENEDICTO" onchange="updateAbsents()">
                            <label for="cons6">Michele BENEDICTO</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="cons7" name="consultants" value="Chitrasen LUXIMON" onchange="updateAbsents()">
                            <label for="cons7">Chitrasen LUXIMON</label>
                        </div>
                    </div>
                    
                    <h4 style="color: #e74c3c; margin: 20px 0 10px 0;">Consultants absents :</h4>
                    <div class="checkbox-grid" id="consultantsAbsents">
                        <div class="checkbox-item">
                            <input type="checkbox" id="abs1" name="absents" value="Alicia DOUAIR" checked onchange="updatePresents()">
                            <label for="abs1">Alicia DOUAIR</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="abs2" name="absents" value="Nathalie TRILLO" checked onchange="updatePresents()">
                            <label for="abs2">Nathalie TRILLO</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="abs3" name="absents" value="Elodie ANTOINE" checked onchange="updatePresents()">
                            <label for="abs3">Elodie ANTOINE</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="abs4" name="absents" value="Caroline BRACONNIER" checked onchange="updatePresents()">
                            <label for="abs4">Caroline BRACONNIER</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="abs5" name="absents" value="Farida BENZIADA" checked onchange="updatePresents()">
                            <label for="abs5">Farida BENZIADA</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="abs6" name="absents" value="Michele BENEDICTO" checked onchange="updatePresents()">
                            <label for="abs6">Michele BENEDICTO</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="abs7" name="absents" value="Chitrasen LUXIMON" checked onchange="updatePresents()">
                            <label for="abs7">Chitrasen LUXIMON</label>
                        </div>
                    </div>
                </div>

                <!-- Intervenants -->
                <div class="section">
                    <h3>🎯 Intervenants</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="intervenantsSolerys">Intervenants Solerys :</label>
                            <textarea id="intervenantsSolerys" name="intervenantsSolerys" rows="2" placeholder="Nom, fonction..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="intervenantsExterieurs">Intervenants extérieurs :</label>
                            <textarea id="intervenantsExterieurs" name="intervenantsExterieurs" rows="2" placeholder="Nom, entreprise, fonction..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- P.P.P. -->
                <div class="section">
                    <h3>📊 P.P.P. (Partages des Pratiques Professionnelles)</h3>
                    <div class="checkbox-grid">
                        <div style="grid-column: 1/-1; font-weight: bold; color: #8bc34a; margin-bottom: 10px;">🔍 Suivi et évaluation</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp1" name="ppp" value="Suivi des actions précédentes">
                            <label for="ppp1">Suivi des actions précédentes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp2" name="ppp" value="Bilan des indicateurs">
                            <label for="ppp2">Bilan des indicateurs</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp3" name="ppp" value="Évaluation des pratiques">
                            <label for="ppp3">Évaluation des pratiques</label>
                        </div>
                        
                        <div style="grid-column: 1/-1; font-weight: bold; color: #8bc34a; margin: 20px 0 10px 0;">🛠️ Outils et méthodes</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp4" name="ppp" value="Nouveaux outils">
                            <label for="ppp4">Nouveaux outils</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp5" name="ppp" value="Méthodes innovantes">
                            <label for="ppp5">Méthodes innovantes</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp6" name="ppp" value="Retours d'expérience">
                            <label for="ppp6">Retours d'expérience</label>
                        </div>

                        <div style="grid-column: 1/-1; font-weight: bold; color: #8bc34a; margin: 20px 0 10px 0;">⚠️ Points de vigilance</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp7" name="ppp" value="Difficultés rencontrées">
                            <label for="ppp7">Difficultés rencontrées</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp8" name="ppp" value="Risques identifiés">
                            <label for="ppp8">Risques identifiés</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp9" name="ppp" value="Points d'amélioration">
                            <label for="ppp9">Points d'amélioration</label>
                        </div>

                        <div style="grid-column: 1/-1; font-weight: bold; color: #8bc34a; margin: 20px 0 10px 0;">🎯 Actions et projets</div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp10" name="ppp" value="Nouvelles actions">
                            <label for="ppp10">Nouvelles actions</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp11" name="ppp" value="Planning des projets">
                            <label for="ppp11">Planning des projets</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ppp12" name="ppp" value="Ressources nécessaires">
                            <label for="ppp12">Ressources nécessaires</label>
                        </div>
                    </div>
                </div>

                <!-- Ordre du jour -->
                <div class="section">
                    <h3>📝 Ordre du jour</h3>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="ajouterPointOrdreJour()">➕ Ajouter un point</button>
                        <button type="button" class="btn btn-success" onclick="genererOrdreJourAuto()">🔧 Compléter avec P.P.P.</button>
                    </div>
                    <div id="ordreJourList" style="margin-top: 20px;"></div>
                </div>

                <!-- Synthèse -->
                <div class="section">
                    <h3>📄 Synthèse de la réunion</h3>
                    <div class="btn-group">
                        <button type="button" class="btn btn-success" onclick="genererSyntheseIA()">🤖 Compléter avec IA</button>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="synthese">Synthèse :</label>
                        <textarea id="synthese" name="synthese" rows="6" placeholder="Synthèse de la réunion..." onInput="updateCharCount('synthese', 1000)"></textarea>
                        <div class="char-counter" id="syntheseCount">0/1000 caractères</div>
                    </div>
                </div>

                <!-- Actions de finalisation -->
                <div class="section">
                    <h3>🎯 Finalisation</h3>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="sauvegarder()">💾 Sauvegarder</button>
                        <button type="button" class="btn btn-secondary" onclick="charger()">📂 Charger</button>
                        <button type="button" class="btn btn-success" onclick="genererPDF()">📄 Générer PDF</button>
                        <button type="button" class="btn btn-primary" onclick="finaliserCompteRendu()">✓ Finaliser le compte-rendu</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Chargement -->
    <div id="chargementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>📂 Charger un formulaire</h3>
                <span class="close" onclick="fermerChargement()">&times;</span>
            </div>
            <p>Chargement des sauvegardes...</p>
        </div>
    </div>

    <!-- Status de sauvegarde -->
    <div id="saveStatus" class="save-status">💾 Sauvegardé !</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        let ordreJourCounter = 0;
        const consultantsList = [
            'Alicia DOUAIR', 'Nathalie TRILLO', 'Elodie ANTOINE', 'Caroline BRACONNIER', 
            'Farida BENZIADA', 'Michele BENEDICTO', 'Chitrasen LUXIMON'
        ];

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            updateProgress();
            updateHoraires();
            updateAbsents();
            setupDragAndDrop();
            setupAutoSave();
        });

        // Ajout de la date à la référence
        function ajouterDateReference() {
            const dateInput = document.getElementById('date').value;
            const referenceInput = document.getElementById('reference');
            
            if (!dateInput) {
                alert('⚠️ Veuillez d\'abord sélectionner une date !');
                return;
            }
            
            const date = new Date(dateInput);
            const jour = String(date.getDate()).padStart(2, '0');
            const mois = String(date.getMonth() + 1).padStart(2, '0');
            const dateFormatee = jour + mois;
            
            let referenceActuelle = referenceInput.value;
            if (referenceActuelle && !referenceActuelle.endsWith('/')) {
                referenceActuelle += '/';
            }
            referenceInput.value = referenceActuelle + dateFormatee;
            
            updateProgress();
        }

        // Gestion des horaires
        function updateHoraires() {
            const debut = document.getElementById('heureDebut').value;
            const fin = document.getElementById('heureFin').value;
            
            if (debut && fin) {
                const debutFormat = debut.replace(':', 'h');
                const finFormat = fin.replace(':', 'h');
                
                const [hDebut, mDebut] = debut.split(':').map(Number);
                const [hFin, mFin] = fin.split(':').map(Number);
                
                const minutesDebut = hDebut * 60 + mDebut;
                const minutesFin = hFin * 60 + mFin;
                const dureMinutes = minutesFin - minutesDebut;
                
                if (dureMinutes > 0) {
                    const heures = Math.floor(dureMinutes / 60);
                    const minutes = dureMinutes % 60;
                    
                    let dureeText = '';
                    if (heures > 0) dureeText += heures + 'h';
                    if (minutes > 0) dureeText += (heures > 0 ? '' : '') + (minutes < 10 && heures > 0 ? '0' : '') + minutes + (heures > 0 ? '' : 'min');
                    if (dureeText === '') dureeText = '0min';
                    
                    document.getElementById('dureeAffichage').textContent = `(${dureeText})`;
                    document.getElementById('horaires').value = `${debutFormat}00 à ${finFormat}00`;
                } else {
                    document.getElementById('dureeAffichage').textContent = '(Durée invalide)';
                    document.getElementById('dureeAffichage').style.color = '#e74c3c';
                    setTimeout(() => {
                        document.getElementById('dureeAffichage').style.color = '#666';
                    }, 2000);
                }
            }
            updateProgress();
        }

        // Gestion des absents/présents
        function updateAbsents() {
            const presents = Array.from(document.querySelectorAll('input[name="consultants"]:checked'))
                .map(cb => cb.value);
            
            consultantsList.forEach(consultant => {
                const absentCheckbox = document.querySelector(`input[name="absents"][value="${consultant}"]`);
                if (absentCheckbox) {
                    absentCheckbox.checked = !presents.includes(consultant);
                }
            });
            
            updateProgress();
        }

        function updatePresents() {
            const absents = Array.from(document.querySelectorAll('input[name="absents"]:checked'))
                .map(cb => cb.value);
            
            consultantsList.forEach(consultant => {
                const presentCheckbox = document.querySelector(`input[name="consultants"][value="${consultant}"]`);
                if (presentCheckbox) {
                    presentCheckbox.checked = !absents.includes(consultant);
                }
            });
            
            updateProgress();
        }

        // Barre de progression
        function updateProgress() {
            const inputs = document.querySelectorAll('input[required]:not([type="hidden"]), select[required]');
            const filled = Array.from(inputs).filter(input => input.value.trim() !== '').length;
            const progress = (filled / inputs.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
        }

        // Gestion de l'ordre du jour
        function ajouterPointOrdreJour() {
            ordreJourCounter++;
            const container = document.getElementById('ordreJourList');
            const div = document.createElement('div');
            div.className = 'ordre-jour-item';
            div.draggable = true;
            div.innerHTML = `
                <button type="button" class="delete-item" onclick="supprimerPoint(this)">🗑️</button>
                <div style="margin-bottom: 10px;">
                    <input type="text" placeholder="Titre du point ${ordreJourCounter}" style="width: 100%; margin-bottom: 10px; font-size: 16px; padding: 12px; font-weight: 600;">
                    <textarea placeholder="Description et objectifs pédagogiques de ce point" style="width: 100%; font-size: 14px; padding: 12px; min-height: 80px;"></textarea>
                </div>
            `;
            container.appendChild(div);
            setupDragAndDrop();
        }

        function supprimerPoint(button) {
            button.parentElement.remove();
        }

        // Génération automatique basée sur les P.P.P. - VERSION CORRIGÉE
        function genererOrdreJourAuto() {
            const pppChecked = Array.from(document.querySelectorAll('input[name="ppp"]:checked'))
                .map(cb => cb.value);
            
            if (pppChecked.length === 0) {
                alert('Veuillez sélectionner au moins une thématique P.P.P. pour compléter l\'ordre du jour automatiquement.');
                return;
            }

            const existingItems = document.getElementById('ordreJourList').querySelectorAll('.ordre-jour-item');
            if (existingItems.length > 0) {
                const confirmer = confirm(`✅ COMPLÉTER L'ORDRE DU JOUR\n\nVous avez déjà ${existingItems.length} point(s) dans votre ordre du jour.\n\nCette action va AJOUTER les points P.P.P. sélectionnés à votre ordre du jour existant.\n\n➤ Voulez-vous continuer ?`);
                if (!confirmer) {
                    return;
                }
            }

            const container = document.getElementById('ordreJourList');
            
            // Ajouter les points fixes seulement si la liste est complètement vide
            const existingItemsAfterConfirm = container.querySelectorAll('.ordre-jour-item');
            if (existingItemsAfterConfirm.length === 0) {
                const pointsIntroductifs = [
                    { 
                        titre: 'Ouverture de la séance et tour de table', 
                        description: 'Présentation des participants, validation de l\'ordre du jour et objectifs de la séance'
                    },
                    { 
                        titre: 'Bilan des actions de développement précédentes', 
                        description: 'Évaluation de la mise en œuvre des actions définies lors de la dernière session P.P.P.'
                    }
                ];
                
                pointsIntroductifs.forEach(point => {
                    ordreJourCounter++;
                    const div = document.createElement('div');
                    div.className = 'ordre-jour-item';
                    div.draggable = true;
                    div.innerHTML = `
                        <button type="button" class="delete-item" onclick="supprimerPoint(this)">🗑️</button>
                        <div style="margin-bottom: 10px;">
                            <input type="text" value="${point.titre}" style="width: 100%; margin-bottom: 10px; font-size: 16px; padding: 12px; font-weight: 600;">
                            <textarea style="width: 100%; font-size: 14px; padding: 12px; min-height: 80px;">${point.description}</textarea>
                        </div>
                    `;
                    container.appendChild(div);
                });
            }

            // Points basés sur les P.P.P.
            const mappingPPP = {
                'Suivi des actions précédentes': {
                    titre: 'Analyse de l\'efficacité des dispositifs d\'accompagnement',
                    description: 'Évaluation des résultats des actions mises en place, identification des leviers de réussite et des axes d\'amélioration'
                },
                'Bilan des indicateurs': {
                    titre: 'Tableaux de bord et indicateurs de performance',
                    description: 'Analyse des données quantitatives et qualitatives, taux de sortie positive, durée moyenne d\'accompagnement'
                },
                'Évaluation des pratiques': {
                    titre: 'Analyse réflexive des méthodes d\'intervention',
                    description: 'Évaluation critique des outils et techniques utilisés, identification des bonnes pratiques transférables'
                },
                'Nouveaux outils': {
                    titre: 'Présentation d\'outils innovants d\'accompagnement',
                    description: 'Découverte de nouvelles méthodologies, outils numériques et supports pédagogiques adaptés au public'
                },
                'Méthodes innovantes': {
                    titre: 'Expérimentation de démarches novatrices',
                    description: 'Partage d\'approches créatives, techniques de mobilisation et stratégies d\'activation des bénéficiaires'
                },
                'Retours d\'expérience': {
                    titre: 'Capitalisation des expériences terrain',
                    description: 'Analyse de situations complexes, partage de cas pratiques et co-construction de solutions'
                },
                'Difficultés rencontrées': {
                    titre: 'Identification des freins à l\'insertion professionnelle',
                    description: 'Analyse des obstacles rencontrés, problématiques récurrentes et stratégies de contournement'
                },
                'Risques identifiés': {
                    titre: 'Anticipation des risques de rupture de parcours',
                    description: 'Détection précoce des signaux d\'alerte, mise en place de mesures préventives'
                },
                'Points d\'amélioration': {
                    titre: 'Optimisation des parcours d\'accompagnement',
                    description: 'Identification des axes de progression, amélioration continue des pratiques professionnelles'
                },
                'Nouvelles actions': {
                    titre: 'Définition des priorités d\'action',
                    description: 'Élaboration de nouvelles stratégies d\'intervention, planification des actions prioritaires'
                },
                'Planning des projets': {
                    titre: 'Coordination des projets d\'insertion',
                    description: 'Planification des actions collectives, coordination avec les partenaires du territoire'
                },
                'Ressources nécessaires': {
                    titre: 'Mobilisation des ressources et partenariats',
                    description: 'Identification des besoins en formation, outils et partenariats stratégiques'
                }
            };

            pppChecked.forEach(ppp => {
                const mapping = mappingPPP[ppp];
                if (mapping) {
                    ordreJourCounter++;
                    const div = document.createElement('div');
                    div.className = 'ordre-jour-item';
                    div.draggable = true;
                    div.innerHTML = `
                        <button type="button" class="delete-item" onclick="supprimerPoint(this)">🗑️</button>
                        <div style="margin-bottom: 10px;">
                            <input type="text" value="${mapping.titre}" style="width: 100%; margin-bottom: 10px; font-size: 16px; padding: 12px; font-weight: 600;">
                            <textarea style="width: 100%; font-size: 14px; padding: 12px; min-height: 80px;">${mapping.description}</textarea>
                        </div>
                    `;
                    container.appendChild(div);
                }
            });

            // Point de clôture
            ordreJourCounter++;
            const divCloture = document.createElement('div');
            divCloture.className = 'ordre-jour-item';
            divCloture.draggable = true;
            divCloture.innerHTML = `
                <button type="button" class="delete-item" onclick="supprimerPoint(this)">🗑️</button>
                <div style="margin-bottom: 10px;">
                    <input type="text" value="Synthèse et engagement sur le plan d'action" style="width: 100%; margin-bottom: 10px; font-size: 16px; padding: 12px; font-weight: 600;">
                    <textarea style="width: 100%; font-size: 14px; padding: 12px; min-height: 80px;">Récapitulatif des décisions prises, validation du plan d'action, définition des échéances et modalités de suivi</textarea>
                </div>
            `;
            container.appendChild(divCloture);
            
            setupDragAndDrop();
        }

        // Drag & Drop
        function setupDragAndDrop() {
            const items = document.querySelectorAll('.ordre-jour-item');
            items.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e) {
            e.preventDefault();
            const draggedHTML = e.dataTransfer.getData('text/html');
            this.insertAdjacentHTML('beforebegin', draggedHTML);
            const dragged = document.querySelector('.dragging');
            if (dragged) dragged.remove();
            setupDragAndDrop();
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
        }

        // Génération de synthèse IA - VERSION AVEC CORRECTION ORTHOGRAPHIQUE
        function genererSyntheseIA() {
            const sites = Array.from(document.querySelectorAll('input[name="sites"]:checked')).map(cb => cb.value);
            const presents = Array.from(document.querySelectorAll('input[name="consultants"]:checked')).map(cb => cb.value);
            const ppp = Array.from(document.querySelectorAll('input[name="ppp"]:checked')).map(cb => cb.value);
            
            // Récupérer les points de l'ordre du jour saisis par l'utilisateur
            const ordreJourItems = Array.from(document.querySelectorAll('.ordre-jour-item')).map(item => {
                const titre = item.querySelector('input[type="text"]')?.value || '';
                const description = item.querySelector('textarea')?.value || '';
                return { 
                    titre: corrigerTexte(titre.trim()), 
                    description: corrigerTexte(description.trim()) 
                };
            }).filter(item => item.titre !== '');

            let synthese = "SYNTHÈSE DE LA SESSION DE PARTAGES DES PRATIQUES PROFESSIONNELLES\n\n";
            
            // CONTEXTE ET PARTICIPATION
            synthese += "1. CONTEXTE ET PARTICIPATION\n";
            if (sites.length > 0) {
                synthese += `Cette session P.P.P. a réuni les équipes d'accompagnement de ${sites.length} site${sites.length > 1 ? 's' : ''} : ${sites.join(', ')}. `;
            }
            
            if (presents.length > 0) {
                synthese += `La participation active de ${presents.length} consultant${presents.length > 1 ? 's' : ''} en insertion professionnelle a favorisé des échanges constructifs et un partage d'expériences enrichissant.\n\n`;
            }
            
            // SYNTHÈSE RÉDIGÉE EN PHRASES FLUIDES ET CORRIGÉES
            if (ordreJourItems.length > 0) {
                synthese += "2. SYNTHESE DES ECHANGES\n";
                
                // Créer un paragraphe fluide et correct
                let paragraphe = "";
                
                ordreJourItems.forEach((item, index) => {
                    if (index === 0) {
                        paragraphe += `Durant cette session, nous avons principalement travaillé sur ${item.titre.toLowerCase()}`;
                        if (item.description) {
                            paragraphe += ` afin de ${item.description.toLowerCase()}`;
                        }
                        paragraphe += ". ";
                    } else {
                        paragraphe += `Nous avons également abordé ${item.titre.toLowerCase()}`;
                        if (item.description) {
                            paragraphe += ` dans le but de ${item.description.toLowerCase()}`;
                        }
                        paragraphe += ". ";
                    }
                });
                
                paragraphe += "Ces différents sujets ont permis d'enrichir notre réflexion collective et de renforcer notre approche professionnelle. ";
                paragraphe += "Les échanges ont été constructifs et ont favorisé l'émergence de nouvelles perspectives d'amélioration de nos pratiques d'accompagnement.";
                
                // Corriger le paragraphe complet
                paragraphe = corrigerParagraphe(paragraphe);
                
                synthese += paragraphe + "\n\n";
            }
            
            // P.P.P. - UNIQUEMENT LA LISTE DES CASES COCHÉES
            if (ppp.length > 0) {
                synthese += "3. THEMATIQUES P.P.P. ABORDEES\n";
                ppp.forEach(theme => {
                    synthese += `• ${theme}\n`;
                });
            }

            document.getElementById('synthese').value = synthese;
            updateCharCount('synthese', 1000);
            
            // Notification de succès
            alert(`✅ SYNTHÈSE CORRIGÉE GÉNÉRÉE !\n\n🎯 ${ordreJourItems.length} point(s) transformés en phrases fluides\n📊 ${ppp.length} axe(s) P.P.P. listés simplement\n✏️ Orthographe et syntaxe corrigées !`);
        }

        // Fonction de correction orthographique et syntaxique basique
        function corrigerTexte(texte) {
            if (!texte) return texte;
            
            return texte
                // Corrections courantes d'orthographe
                .replace(/\breçus\b/g, 'reçus')
                .replace(/\brecus\b/g, 'reçus')
                .replace(/\bstatistique\b/g, 'statistiques')
                .replace(/\bprofessionel\b/g, 'professionnel')
                .replace(/\bprofesionnel\b/g, 'professionnel')
                // Majuscules en début de phrase
                .replace(/^([a-z])/g, (match, letter) => letter.toUpperCase())
                // Espaces multiples
                .replace(/\s+/g, ' ')
                // Espaces avant ponctuation
                .replace(/\s+([.,;!?])/g, '$1')
                .trim();
        }

        // Fonction de correction de paragraphe
        function corrigerParagraphe(paragraphe) {
            return paragraphe
                // Corrections d'accord
                .replace(/nous avons reçus/g, 'nous avons reçu')
                .replace(/nous avons reçu les félicitations/g, 'nous avons reçu des félicitations')
                // Corrections de syntaxe courantes
                .replace(/afin que les consultants soient au courant de cette prise en charge/g, 'afin d\'informer les consultants de cette prise en charge')
                // Majuscules après points
                .replace(/\.\s+([a-z])/g, (match, letter) => '. ' + letter.toUpperCase())
                // Nettoyage final
                .replace(/\s+/g, ' ')
                .trim();
        }

        // Compteur de caractères
        function updateCharCount(textareaId, maxLength) {
            const textarea = document.getElementById(textareaId);
            const counter = document.getElementById(textareaId + 'Count');
            const currentLength = textarea.value.length;
            
            counter.textContent = `${currentLength}/${maxLength} caractères`;
            
            if (currentLength > maxLength * 0.9) {
                counter.className = 'char-counter danger';
            } else if (currentLength > maxLength * 0.7) {
                counter.className = 'char-counter warning';
            } else {
                counter.className = 'char-counter';
            }
            
            updateProgress();
        }

        // Sauvegarde automatique
        function setupAutoSave() {
            setInterval(() => {
                if (document.getElementById('date').value) {
                    showSaveStatus();
                }
            }, 30000);
        }

        function showSaveStatus() {
            const status = document.getElementById('saveStatus');
            status.classList.add('show');
            setTimeout(() => status.classList.remove('show'), 2000);
        }

        // Fonctions de sauvegarde/chargement
        function sauvegarder() {
            const formData = collectFormData();
            const jsonData = JSON.stringify(formData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reunion-vs2-${formData.date || 'sans-date'}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showSaveStatus();
        }

        function charger() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            chargerDonnees(data);
                        } catch (error) {
                            alert('Erreur lors du chargement du fichier : ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function chargerDonnees(data) {
            // Charger les données dans le formulaire
            Object.keys(data).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.value = data[key];
                }
            });
            
            // Charger les checkboxes
            if (data.sites) {
                data.sites.forEach(site => {
                    const checkbox = document.querySelector(`input[name="sites"][value="${site}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            if (data.consultants) {
                data.consultants.forEach(consultant => {
                    const checkbox = document.querySelector(`input[name="consultants"][value="${consultant}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            if (data.ppp) {
                data.ppp.forEach(ppp => {
                    const checkbox = document.querySelector(`input[name="ppp"][value="${ppp}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            updateProgress();
            updateAbsents();
            updateHoraires();
        }

        function collectFormData() {
            return {
                reference: document.getElementById('reference').value,
                date: document.getElementById('date').value,
                heureDebut: document.getElementById('heureDebut').value,
                heureFin: document.getElementById('heureFin').value,
                animateur: document.getElementById('animateur').value,
                modalite: document.getElementById('modalite').value,
                sites: Array.from(document.querySelectorAll('input[name="sites"]:checked')).map(cb => cb.value),
                consultants: Array.from(document.querySelectorAll('input[name="consultants"]:checked')).map(cb => cb.value),
                intervenantsSolerys: document.getElementById('intervenantsSolerys').value,
                intervenantsExterieurs: document.getElementById('intervenantsExterieurs').value,
                ppp: Array.from(document.querySelectorAll('input[name="ppp"]:checked')).map(cb => cb.value),
                synthese: document.getElementById('synthese').value
            };
        }

        // Finalisation
        function finaliserCompteRendu() {
            const date = document.getElementById('date').value;
            const animateur = document.getElementById('animateur').value;
            const modalite = document.getElementById('modalite').value;
            const heureDebut = document.getElementById('heureDebut').value;
            const heureFin = document.getElementById('heureFin').value;
            
            if (!date || !animateur || !modalite || !heureDebut || !heureFin) {
                alert('⚠️ Veuillez remplir les champs obligatoires :\n- Date\n- Horaires (début et fin)\n- Animateur\n- Modalité');
                return;
            }
            
            const confirmer = confirm('✓ Compte-rendu finalisé avec succès !\n\n📄 Souhaitez-vous générer le PDF maintenant ?');
            if (confirmer) {
                genererPDF();
            }
        }

        // Génération PDF - VRAI PDF avec jsPDF
        function genererPDF() {
            const formData = collectFormData();
            
            // Créer un nouveau document PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuration des couleurs
            const colorVert = [139, 195, 74]; // #8bc34a
            const colorGris = [44, 62, 80];   // #2c3e50
            
            let yPos = 20;
            let sectionNumber = 1; // Compteur pour les sections
            
            // === EN-TÊTE ===
            doc.setFillColor(...colorVert);
            doc.rect(0, 0, 210, 40, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Compte-rendu de Réunion d\'équipe VS2', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text('Partages des Pratiques Professionnelles - Solerys', 105, 30, { align: 'center' });
            
            yPos = 50;
            
            // === INFORMATIONS GÉNÉRALES ===
            doc.setTextColor(...colorVert);
            doc.setFontSize(14);
            doc.setFont('helvetica', 'bold');
            doc.text(`${sectionNumber}. INFORMATIONS GENERALES`, 20, yPos);
            yPos += 10;
            sectionNumber++;
            
            doc.setTextColor(...colorGris);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            const infos = [
                `Référence: ${formData.reference || 'N/A'}`,
                `Date: ${formData.date || 'N/A'}`,
                `Horaires: ${formData.heureDebut || 'N/A'} à ${formData.heureFin || 'N/A'}`,
                `Animateur: ${formData.animateur || 'N/A'}`,
                `Modalité: ${formData.modalite || 'N/A'}`
            ];
            
            infos.forEach(info => {
                doc.text(info, 20, yPos);
                yPos += 5;
            });
            yPos += 5;
            
            // === SITES CONCERNÉS ===
            if (formData.sites && formData.sites.length > 0) {
                doc.setTextColor(...colorVert);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${sectionNumber}. SITES CONCERNES`, 20, yPos);
                yPos += 8;
                sectionNumber++;
                
                doc.setTextColor(...colorGris);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                formData.sites.forEach(site => {
                    doc.text(`• ${site}`, 25, yPos);
                    yPos += 4;
                });
                yPos += 5;
            }
            
            // === PARTICIPANTS PRÉSENTS ===
            if (formData.consultants && formData.consultants.length > 0) {
                doc.setTextColor(...colorVert);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${sectionNumber}. PARTICIPANTS PRESENTS`, 20, yPos);
                yPos += 8;
                sectionNumber++;
                
                doc.setTextColor(...colorGris);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                formData.consultants.forEach(consultant => {
                    doc.text(`• ${consultant}`, 25, yPos);
                    yPos += 4;
                });
                yPos += 5;
            }
            
            // === INTERVENANTS ===
            if (formData.intervenantsSolerys || formData.intervenantsExterieurs) {
                doc.setTextColor(...colorVert);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${sectionNumber}. INTERVENANTS`, 20, yPos);
                yPos += 8;
                sectionNumber++;
                
                doc.setTextColor(...colorGris);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                
                if (formData.intervenantsSolerys) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Solerys:', 25, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(formData.intervenantsSolerys, 50, yPos);
                    yPos += 5;
                }
                
                if (formData.intervenantsExterieurs) {
                    doc.setFont('helvetica', 'bold');
                    doc.text('Extérieurs:', 25, yPos);
                    doc.setFont('helvetica', 'normal');
                    doc.text(formData.intervenantsExterieurs, 55, yPos);
                    yPos += 5;
                }
                yPos += 3;
            }
            
            // === P.P.P. ABORDÉES ===
            if (formData.ppp && formData.ppp.length > 0) {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setTextColor(...colorVert);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${sectionNumber}. P.P.P. ABORDEES`, 20, yPos);
                yPos += 8;
                sectionNumber++;
                
                doc.setTextColor(...colorGris);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                formData.ppp.forEach(ppp => {
                    doc.text(`• ${ppp}`, 25, yPos);
                    yPos += 4;
                });
                yPos += 5;
            }
            
            // === ORDRE DU JOUR ===
            const ordreJour = Array.from(document.querySelectorAll('.ordre-jour-item')).map(item => {
                const titre = item.querySelector('input[type="text"]')?.value || '';
                const description = item.querySelector('textarea')?.value || '';
                return { titre, description };
            }).filter(item => item.titre);
            
            if (ordreJour.length > 0) {
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setTextColor(...colorVert);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${sectionNumber}. ORDRE DU JOUR`, 20, yPos);
                yPos += 10;
                sectionNumber++;
                
                doc.setTextColor(...colorGris);
                doc.setFontSize(10);
                
                ordreJour.forEach((item, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.text(`${index + 1}. ${item.titre}`, 25, yPos);
                    yPos += 5;
                    
                    if (item.description) {
                        doc.setFont('helvetica', 'normal');
                        const lines = doc.splitTextToSize(item.description, 160);
                        lines.forEach(line => {
                            if (yPos > 280) {
                                doc.addPage();
                                yPos = 20;
                            }
                            doc.text(line, 30, yPos);
                            yPos += 4;
                        });
                    }
                    yPos += 3;
                });
            }
            
            // === SYNTHÈSE ===
            if (formData.synthese && formData.synthese.trim()) {
                if (yPos > 200) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setTextColor(...colorVert);
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`${sectionNumber}. SYNTHESE`, 20, yPos);
                yPos += 10;
                
                doc.setTextColor(...colorGris);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                const syntheseLines = doc.splitTextToSize(formData.synthese, 170);
                syntheseLines.forEach(line => {
                    if (yPos > 280) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(line, 20, yPos);
                    yPos += 4;
                });
            }
            
            // === FOOTER ===
            const pageCount = doc.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setTextColor(150, 150, 150);
                doc.setFontSize(8);
                doc.text('SOLERYS - OASYS & Cie | www.solerys.fr', 105, 290, { align: 'center' });
                doc.text(`Document généré le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}`, 105, 295, { align: 'center' });
                doc.text(`Page ${i} / ${pageCount}`, 190, 295);
            }
            
            // Télécharger le PDF
            const fileName = `compte-rendu-vs2-${formData.date || 'sans-date'}.pdf`;
            doc.save(fileName);
            
            // Message de confirmation
            alert(`✅ PDF GÉNÉRÉ AVEC SUCCÈS !\n\n📁 Fichier téléchargé : ${fileName}\n📍 Emplacement : Dossier Téléchargements`);
        }

        // Fermeture des modals
        function fermerChargement() {
            document.getElementById('chargementModal').style.display = 'none';
        }

        // Event listeners
        document.addEventListener('input', updateProgress);

        // Fermeture des modals en cliquant à l'extérieur
        window.addEventListener('click', function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
